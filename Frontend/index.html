<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercadona AI Optimizer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #007a3e;
            --primary-dark: #005c2f;
            --primary-light: #e6f5ed;
            --color-a: #10b981;
            --color-b: #3b82f6;
            --color-c: #8557f1;
            --desayuno: #f59e0b;
            --comida: #ef4444;
            --merienda: #10b981;
            --cena: #6366f1;
            --bg-body: #f3f4f6;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --font: 'Inter', system-ui, sans-serif;
            --radius: 14px;
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 50px -10px rgba(0, 0, 0, 0.12);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font);
            background: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ============================= */
        /* AUTH SCREEN (LANDING PAGE)    */
        /* ============================= */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            background:
                radial-gradient(ellipse at 0% 0%, hsla(150, 60%, 90%, 0.8) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, hsla(220, 60%, 92%, 0.8) 0%, transparent 50%),
                var(--bg-body);
        }

        .auth-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .auth-brand {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-brand h1 {
            font-size: 2.4rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1.5px;
        }

        .auth-brand p {
            color: var(--text-light);
            font-size: 1rem;
            margin-top: 6px;
        }

        .auth-card {
            background: white;
            border-radius: 24px;
            padding: 36px;
            width: 100%;
            max-width: 440px;
            box-shadow: var(--shadow-lg);
        }

        /* Tabs */
        .auth-tabs {
            display: flex;
            background: var(--bg-body);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 28px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            color: var(--text-light);
        }

        .auth-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Auth form inputs */
        .auth-field {
            margin-bottom: 16px;
        }

        .auth-field label {
            display: block;
            font-weight: 700;
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font);
            transition: border 0.3s;
        }

        .auth-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .auth-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Profile picker in register */
        .profile-picker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .profile-option {
            padding: 10px 6px;
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.7rem;
            font-weight: 700;
            line-height: 1.3;
        }

        .profile-option:hover {
            border-color: var(--primary);
        }

        .profile-option.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .profile-option .p-icon {
            font-size: 1.3rem;
            display: block;
            margin-bottom: 3px;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 122, 62, 0.3);
        }

        .auth-error {
            background: #fef2f2;
            color: #ef4444;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 14px;
            display: none;
        }

        /* ============================= */
        /* APP SCREEN (AFTER LOGIN)      */
        /* ============================= */
        #app-screen {
            display: none;
            min-height: 100vh;
        }

        .app-bg {
            background:
                radial-gradient(at 0% 0%, hsla(138, 40%, 92%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(210, 40%, 92%, 1) 0, transparent 50%);
            padding: 24px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Top bar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .topbar h1 {
            font-size: 1.6rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1px solid var(--border);
            padding: 6px 8px 6px 6px;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-pill:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-pill-name {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .btn-icon {
            background: none;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--text-light);
        }

        .btn-icon:hover {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-icon.danger:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Controls */
        .controls-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 24px 28px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-group label {
            font-weight: 700;
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .label-hint {
            font-weight: 400;
            font-size: 0.6rem;
            text-transform: none;
            opacity: 0.7;
        }

        input[type="number"] {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
            font-family: var(--font);
            background: #fff;
            transition: all 0.3s;
        }

        input[type="number"]:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 62, 0.1);
        }

        .optional-section {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px dashed var(--border);
        }

        .optional-label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .optional-badge {
            background: #e5e7eb;
            color: #6b7280;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.6rem;
            font-weight: 700;
        }

        .btn-generate {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 122, 62, 0.25);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 122, 62, 0.35);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-row {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }

        /* Results */
        #results-area {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 20px;
        }

        .version-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            animation: fadeInUp 0.5s ease-out backwards;
        }

        .version-card:hover {
            transform: translateY(-4px);
        }

        .version-header {
            padding: 18px 20px;
            color: white;
            position: relative;
        }

        .va-header {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .vb-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .vc-header {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .version-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .version-price {
            font-size: 2.2rem;
            font-weight: 900;
            line-height: 1;
        }

        .version-meta {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 20px;
        }

        .meal-section {
            border-bottom: 1px solid #f3f4f6;
        }

        .meal-section:last-child {
            border-bottom: none;
        }

        .meal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 16px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .meal-header:hover {
            background: #f9fafb;
        }

        .meal-icon {
            font-size: 1rem;
            width: 22px;
            text-align: center;
        }

        .meal-name {
            font-weight: 700;
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-grow: 1;
        }

        .meal-count {
            font-size: 0.65rem;
            color: var(--text-light);
            font-weight: 600;
            background: #f3f4f6;
            padding: 2px 7px;
            border-radius: 10px;
        }

        .meal-name.desayuno {
            color: var(--desayuno);
        }

        .meal-name.comida {
            color: var(--comida);
        }

        .meal-name.merienda {
            color: var(--merienda);
        }

        .meal-name.cena {
            color: var(--cena);
        }

        .meal-items {
            padding: 0 16px 10px;
        }

        .product-row {
            display: flex;
            align-items: center;
            padding: 6px 0;
            gap: 10px;
            border-bottom: 1px solid #f9fafb;
        }

        .product-row:last-child {
            border-bottom: none;
        }

        .p-emoji {
            font-size: 0.95rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .p-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 0.83rem;
        }

        .p-price {
            font-weight: 700;
            font-size: 0.83rem;
        }

        .version-footer {
            padding: 10px 16px;
            background: #f9fafb;
            font-size: 0.68rem;
            color: var(--text-light);
            text-align: center;
            font-weight: 600;
        }

        .loader,
        .error-msg {
            text-align: center;
            padding: 24px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            display: none;
        }

        .error-msg {
            color: #ef4444;
            background: #fef2f2;
            border-radius: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ================================ */
        /* PROFILE MODAL                    */
        /* ================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .profile-modal {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.3s;
        }

        .pm-header {
            padding: 24px 28px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pm-header h2 {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .pm-close {
            background: var(--bg-body);
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pm-close:hover {
            background: #e5e7eb;
        }

        .pm-body {
            padding: 20px 28px 28px;
        }

        /* Avatar upload */
        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--primary);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .avatar-preview:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-hint {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 8px;
            font-weight: 500;
        }

        .pm-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 18px;
        }

        .pm-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pm-field label {
            font-weight: 700;
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pm-input {
            padding: 11px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: var(--font);
            transition: border 0.3s;
        }

        .pm-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .pm-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pm-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .pm-profiles {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .pm-profile {
            padding: 12px 6px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.72rem;
            font-weight: 700;
        }

        .pm-profile:hover {
            border-color: var(--primary);
        }

        .pm-profile.active {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .pm-profile .pi {
            font-size: 1.4rem;
            display: block;
            margin-bottom: 3px;
        }

        .pm-save {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pm-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 62, 0.3);
        }

        .pm-success {
            text-align: center;
            color: var(--primary);
            font-weight: 700;
            font-size: 0.85rem;
            margin-top: 10px;
            display: none;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @media (max-width: 768px) {
            .auth-card {
                margin: 0 16px;
            }

            .profile-picker,
            .pm-profiles {
                grid-template-columns: repeat(2, 1fr);
            }

            #results-area {
                grid-template-columns: 1fr;
            }

            .topbar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .pm-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- ========================================= -->
    <!-- AUTH SCREEN (LANDING)                     -->
    <!-- ========================================= -->
    <div id="auth-screen">
        <div class="auth-left">
            <div class="auth-brand">
                <h1>üõí Mercadona AI</h1>
                <p>Tu compra semanal inteligente</p>
            </div>
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuth('login')">Iniciar sesi√≥n</button>
                    <button class="auth-tab" onclick="switchAuth('register')">Registrarse</button>
                </div>

                <!-- LOGIN -->
                <div id="login-panel">
                    <div class="auth-error" id="login-error"></div>
                    <div class="auth-field">
                        <label>Email</label>
                        <input type="email" class="auth-input" id="login-email" placeholder="tu@email.com">
                    </div>
                    <div class="auth-field">
                        <label>Contrase√±a</label>
                        <input type="password" class="auth-input" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="auth-btn" onclick="doLogin()">Entrar</button>
                </div>

                <!-- REGISTER -->
                <div id="register-panel" style="display:none">
                    <div class="auth-error" id="reg-error"></div>
                    <div class="auth-row">
                        <div class="auth-field">
                            <label>Nombre *</label>
                            <input type="text" class="auth-input" id="reg-nombre" placeholder="Miguel">
                        </div>
                        <div class="auth-field">
                            <label>Apellidos</label>
                            <input type="text" class="auth-input" id="reg-apellidos" placeholder="Garc√≠a L√≥pez">
                        </div>
                    </div>
                    <div class="auth-field">
                        <label>Email *</label>
                        <input type="email" class="auth-input" id="reg-email" placeholder="tu@email.com">
                    </div>
                    <div class="auth-field">
                        <label>Contrase√±a *</label>
                        <input type="password" class="auth-input" id="reg-pass" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="auth-field">
                        <label>Perfil de dieta</label>
                        <div class="profile-picker" id="reg-profile-picker">
                            <!-- filled by JS -->
                        </div>
                    </div>
                    <button class="auth-btn" onclick="doRegister()">Crear cuenta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- APP SCREEN (AFTER LOGIN)                  -->
    <!-- ========================================= -->
    <div id="app-screen">
        <div class="app-bg">
            <div class="container">
                <div class="topbar">
                    <h1>Mercadona AI Optimizer</h1>
                    <div class="topbar-actions">
                        <div class="user-pill" onclick="openProfileModal()">
                            <div class="user-avatar" id="topbar-avatar">üë§</div>
                            <span class="user-pill-name" id="topbar-name">Usuario</span>
                        </div>
                        <button class="btn-icon" onclick="openProfileModal()">‚öôÔ∏è Perfil</button>
                        <button class="btn-icon danger" onclick="logout()">Salir</button>
                    </div>
                </div>

                <!-- Controls -->
                <section class="controls-card">
                    <div class="controls-grid">
                        <div class="input-group">
                            <label>üí∞ Presupuesto <span class="label-hint">(‚Ç¨/semana)</span></label>
                            <input type="number" id="presupuesto" value="50" min="20">
                        </div>
                        <div class="input-group">
                            <label>ü•© Prote√≠nas <span class="label-hint">(g/d√≠a)</span></label>
                            <input type="number" id="proteina" value="150">
                        </div>
                        <div class="input-group">
                            <label>üî• Calor√≠as <span class="label-hint">(kcal/d√≠a)</span></label>
                            <input type="number" id="calorias" value="2400">
                        </div>
                    </div>
                    <div class="optional-section">
                        <div class="optional-label">Macros avanzados <span class="optional-badge">Opcional</span></div>
                        <div class="controls-grid">
                            <div class="input-group">
                                <label>üçû Carbohidratos <span class="label-hint">(g/d√≠a)</span></label>
                                <input type="number" id="carbohidratos" placeholder="Ej: 300">
                            </div>
                            <div class="input-group">
                                <label>üßà Grasas <span class="label-hint">(g/d√≠a)</span></label>
                                <input type="number" id="grasas" placeholder="Ej: 80">
                            </div>
                        </div>
                    </div>
                    <div class="btn-row">
                        <button class="btn-generate" id="btn-gen" onclick="calcular()">Generar Compra Semanal ‚ú®</button>
                    </div>
                </section>

                <div id="loader" class="loader">üß† Generando 3 versiones de cesta semanal...</div>
                <div id="error-box" class="error-msg"></div>
                <main id="results-area"></main>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- PROFILE MODAL                             -->
    <!-- ========================================= -->
    <div class="modal-overlay" id="profile-overlay" onclick="if(event.target===this)closeProfileModal()">
        <div class="profile-modal">
            <div class="pm-header">
                <h2>‚öôÔ∏è Personalizar perfil</h2>
                <button class="pm-close" onclick="closeProfileModal()">‚úï</button>
            </div>
            <div class="pm-body">
                <!-- Avatar -->
                <div class="avatar-upload">
                    <div class="avatar-preview" id="pm-avatar" onclick="document.getElementById('foto-input').click()">
                        üë§
                    </div>
                    <span class="avatar-hint">Haz clic para cambiar tu foto</span>
                    <input type="file" id="foto-input" accept="image/*" style="display:none"
                        onchange="uploadFoto(this)">
                </div>

                <!-- Datos personales -->
                <div class="pm-grid">
                    <div class="pm-field">
                        <label>Nombre</label>
                        <input type="text" class="pm-input" id="pm-nombre">
                    </div>
                    <div class="pm-field">
                        <label>Apellidos</label>
                        <input type="text" class="pm-input" id="pm-apellidos">
                    </div>
                </div>

                <!-- Perfil de dieta -->
                <div class="pm-section-title">Perfil de dieta</div>
                <div class="pm-profiles" id="pm-profiles">
                    <!-- filled by JS -->
                </div>

                <!-- Macros -->
                <div class="pm-section-title">Macros por defecto</div>
                <div class="pm-grid">
                    <div class="pm-field">
                        <label>Presupuesto (‚Ç¨/sem)</label>
                        <input type="number" class="pm-input" id="pm-presupuesto">
                    </div>
                    <div class="pm-field">
                        <label>Prote√≠nas (g/d√≠a)</label>
                        <input type="number" class="pm-input" id="pm-proteinas">
                    </div>
                    <div class="pm-field">
                        <label>Calor√≠as (kcal/d√≠a)</label>
                        <input type="number" class="pm-input" id="pm-calorias">
                    </div>
                    <div class="pm-field">
                        <label>Carbohidratos (g/d√≠a)</label>
                        <input type="number" class="pm-input" id="pm-carbohidratos" placeholder="Opcional">
                    </div>
                </div>

                <button class="pm-save" onclick="saveProfile()">Guardar cambios</button>
                <div class="pm-success" id="pm-success">‚úÖ Perfil guardado correctamente</div>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://127.0.0.1:8000';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let perfiles = {};
        let selectedRegProfile = 'estandar';
        let selectedPmProfile = 'estandar';

        // ========== INIT ==========
        async function init() {
            await loadPerfiles();
            if (token) {
                const ok = await loadUser();
                if (ok) showApp();
                else showAuth();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
        }

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
        }

        // ========== AUTH ==========
        function switchAuth(type) {
            document.querySelectorAll('.auth-tab').forEach((t, i) => {
                t.classList.toggle('active', (type === 'login' && i === 0) || (type === 'register' && i === 1));
            });
            document.getElementById('login-panel').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('register-panel').style.display = type === 'register' ? 'block' : 'none';
            document.querySelectorAll('.auth-error').forEach(e => e.style.display = 'none');
        }

        async function doLogin() {
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pass').value;
            const errEl = document.getElementById('login-error');
            errEl.style.display = 'none';

            if (!email || !pw) { errEl.innerText = 'Rellena todos los campos'; errEl.style.display = 'block'; return; }

            try {
                const r = await fetch(`${API}/login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password: pw })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.detail || 'Error');
                token = data.token;
                localStorage.setItem('token', token);
                await loadUser();
                showApp();
            } catch (e) {
                errEl.innerText = e.message;
                errEl.style.display = 'block';
            }
        }

        async function doRegister() {
            const nombre = document.getElementById('reg-nombre').value;
            const apellidos = document.getElementById('reg-apellidos').value;
            const email = document.getElementById('reg-email').value;
            const pw = document.getElementById('reg-pass').value;
            const errEl = document.getElementById('reg-error');
            errEl.style.display = 'none';

            if (!nombre || !email || !pw) { errEl.innerText = 'Rellena los campos obligatorios'; errEl.style.display = 'block'; return; }
            if (pw.length < 6) { errEl.innerText = 'La contrase√±a debe tener al menos 6 caracteres'; errEl.style.display = 'block'; return; }

            try {
                const r = await fetch(`${API}/register`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email, password: pw, nombre,
                        apellidos: apellidos || null,
                        perfil_dieta: selectedRegProfile
                    })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.detail || 'Error');
                token = data.token;
                localStorage.setItem('token', token);
                await loadUser();
                showApp();
            } catch (e) {
                errEl.innerText = e.message;
                errEl.style.display = 'block';
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            showAuth();
        }

        async function loadUser() {
            if (!token) return false;
            try {
                const r = await fetch(`${API}/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!r.ok) { logout(); return false; }
                currentUser = await r.json();

                // Update topbar
                document.getElementById('topbar-name').innerText = currentUser.nombre || currentUser.email;
                updateAvatarDisplay();

                // Apply defaults to optimizer inputs
                if (currentUser.presupuesto_default) document.getElementById('presupuesto').value = currentUser.presupuesto_default;
                if (currentUser.proteinas_default) document.getElementById('proteina').value = currentUser.proteinas_default;
                if (currentUser.calorias_default) document.getElementById('calorias').value = currentUser.calorias_default;
                if (currentUser.carbohidratos_default) document.getElementById('carbohidratos').value = currentUser.carbohidratos_default;
                if (currentUser.grasas_default) document.getElementById('grasas').value = currentUser.grasas_default;

                return true;
            } catch (e) { logout(); return false; }
        }

        function updateAvatarDisplay() {
            const topAvatar = document.getElementById('topbar-avatar');
            const pmAvatar = document.getElementById('pm-avatar');
            const initial = (currentUser.nombre || '?')[0].toUpperCase();

            if (currentUser.foto_url) {
                const url = API + currentUser.foto_url;
                topAvatar.innerHTML = `<img src="${url}" alt="">`;
                pmAvatar.innerHTML = `<img src="${url}" alt="">`;
            } else {
                topAvatar.innerHTML = initial;
                pmAvatar.innerHTML = `<span style="font-size:2.5rem">${initial}</span>`;
            }
        }

        // ========== PROFILES ==========
        async function loadPerfiles() {
            try {
                const r = await fetch(`${API}/perfiles`);
                perfiles = await r.json();
                renderRegProfilePicker();
            } catch (e) { console.error(e); }
        }

        const PROFILE_ICONS = {
            estandar: '‚ö°', deportista: 'üèãÔ∏è', deficit: 'ü•ó',
            vegano: 'üå±', vegetariano: 'ü•ö', personalizado: 'üîß'
        };

        function renderRegProfilePicker() {
            const picker = document.getElementById('reg-profile-picker');
            picker.innerHTML = '';
            for (const [key, p] of Object.entries(perfiles)) {
                const opt = document.createElement('div');
                opt.className = 'profile-option' + (key === 'estandar' ? ' active' : '');
                opt.innerHTML = `<span class="p-icon">${PROFILE_ICONS[key] || 'üìã'}</span>${p.nombre.replace(/^[^\s]+\s/, '')}`;
                opt.onclick = () => {
                    selectedRegProfile = key;
                    picker.querySelectorAll('.profile-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                };
                picker.appendChild(opt);
            }
        }

        // ========== PROFILE MODAL ==========
        function openProfileModal() {
            if (!currentUser) return;
            document.getElementById('pm-nombre').value = currentUser.nombre || '';
            document.getElementById('pm-apellidos').value = currentUser.apellidos || '';
            document.getElementById('pm-presupuesto').value = currentUser.presupuesto_default || 50;
            document.getElementById('pm-proteinas').value = currentUser.proteinas_default || 150;
            document.getElementById('pm-calorias').value = currentUser.calorias_default || 2400;
            document.getElementById('pm-carbohidratos').value = currentUser.carbohidratos_default || '';
            selectedPmProfile = currentUser.perfil_dieta || 'estandar';
            renderPmProfiles();
            document.getElementById('pm-success').style.display = 'none';
            document.getElementById('profile-overlay').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profile-overlay').classList.remove('active');
        }

        function renderPmProfiles() {
            const container = document.getElementById('pm-profiles');
            container.innerHTML = '';
            for (const [key, p] of Object.entries(perfiles)) {
                const el = document.createElement('div');
                el.className = 'pm-profile' + (key === selectedPmProfile ? ' active' : '');
                el.innerHTML = `<span class="pi">${PROFILE_ICONS[key] || 'üìã'}</span>${p.nombre.replace(/^[^\s]+\s/, '')}`;
                el.onclick = () => {
                    selectedPmProfile = key;
                    container.querySelectorAll('.pm-profile').forEach(o => o.classList.remove('active'));
                    el.classList.add('active');
                    // Auto-fill macros from profile
                    if (key !== 'personalizado') {
                        document.getElementById('pm-proteinas').value = p.proteinas;
                        document.getElementById('pm-calorias').value = p.calorias;
                        document.getElementById('pm-carbohidratos').value = p.carbohidratos || '';
                    }
                };
                container.appendChild(el);
            }
        }

        async function saveProfile() {
            const payload = {
                nombre: document.getElementById('pm-nombre').value || null,
                apellidos: document.getElementById('pm-apellidos').value || null,
                perfil_dieta: selectedPmProfile,
                presupuesto_default: parseFloat(document.getElementById('pm-presupuesto').value) || null,
                proteinas_default: parseFloat(document.getElementById('pm-proteinas').value) || null,
                calorias_default: parseFloat(document.getElementById('pm-calorias').value) || null,
                carbohidratos_default: parseFloat(document.getElementById('pm-carbohidratos').value) || null,
            };
            try {
                const r = await fetch(`${API}/perfil`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (!r.ok) throw new Error('Error al guardar');
                await loadUser();
                // Update optimizer inputs
                if (payload.presupuesto_default) document.getElementById('presupuesto').value = payload.presupuesto_default;
                if (payload.proteinas_default) document.getElementById('proteina').value = payload.proteinas_default;
                if (payload.calorias_default) document.getElementById('calorias').value = payload.calorias_default;
                if (payload.carbohidratos_default) document.getElementById('carbohidratos').value = payload.carbohidratos_default;
                document.getElementById('pm-success').style.display = 'block';
                setTimeout(() => document.getElementById('pm-success').style.display = 'none', 2000);
            } catch (e) { alert(e.message); }
        }

        async function uploadFoto(input) {
            if (!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            try {
                const r = await fetch(`${API}/upload-foto`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (!r.ok) throw new Error('Error al subir foto');
                const data = await r.json();
                currentUser.foto_url = data.foto_url;
                updateAvatarDisplay();
            } catch (e) { alert(e.message); }
        }

        // ========== OPTIMIZER ==========
        const MEAL_CONFIG = {
            desayuno: { icon: 'üåÖ', label: 'Desayuno' },
            comida: { icon: 'üçΩÔ∏è', label: 'Comida' },
            merienda: { icon: 'üç™', label: 'Merienda' },
            cena: { icon: 'üåô', label: 'Cena' },
        };
        const VERSION_CONFIG = {
            version_a: { label: 'Versi√≥n A', headerClass: 'va-header' },
            version_b: { label: 'Versi√≥n B', headerClass: 'vb-header' },
            version_c: { label: 'Versi√≥n C', headerClass: 'vc-header' },
        };

        async function calcular() {
            const btn = document.getElementById('btn-gen');
            const loader = document.getElementById('loader');
            const results = document.getElementById('results-area');
            const errorBox = document.getElementById('error-box');

            btn.disabled = true; btn.innerHTML = "Calculando...";
            loader.style.display = 'block';
            results.style.display = 'none';
            errorBox.style.display = 'none';

            // Get excluir_tipos from current profile
            const perfil = perfiles[currentUser?.perfil_dieta || 'estandar'];
            const excluir = perfil?.excluir_tipos?.length ? perfil.excluir_tipos : null;

            const data = {
                presupuesto: parseFloat(document.getElementById('presupuesto').value),
                proteinas: parseFloat(document.getElementById('proteina').value),
                calorias: parseFloat(document.getElementById('calorias').value),
                carbohidratos: parseFloat(document.getElementById('carbohidratos').value) || null,
                grasas: parseFloat(document.getElementById('grasas').value) || null,
                excluir_tipos: excluir,
            };

            try {
                const resp = await fetch(`${API}/optimizar`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!resp.ok) throw new Error("Error de conexi√≥n");
                const result = await resp.json();
                if (result.error) throw new Error(result.error);

                results.innerHTML = '';
                for (const [key, cfg] of Object.entries(VERSION_CONFIG)) {
                    const vdata = result[key];
                    if (vdata) results.appendChild(buildCard(vdata, cfg));
                }
                results.style.display = 'grid';
            } catch (e) {
                errorBox.innerText = "‚ùå " + e.message;
                errorBox.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Generar Compra Semanal ‚ú®";
                loader.style.display = 'none';
            }
        }

        function buildCard(data, cfg) {
            const card = document.createElement('article');
            card.className = 'version-card';
            if (data.error) {
                card.innerHTML = `
            <div class="version-header ${cfg.headerClass}">
                <div class="version-label">${cfg.label}</div>
                <div class="version-price">‚Äî</div>
            </div>
            <div style="padding:20px;text-align:center;color:#ef4444;">‚ö†Ô∏è ${data.error}</div>`;
                return card;
            }
            const m = data.macros;
            let html = `
        <div class="version-header ${cfg.headerClass}">
            <div class="version-label">${cfg.label}</div>
            <div class="version-price">${data.precio_total}‚Ç¨</div>
            <div class="version-meta">
                <span class="badge">üî• ${m.kcal} kcal</span>
                <span class="badge">üí™ ${m.prot}g</span>
                <span class="badge">üçû ${m.carb}g</span>
                <span class="badge">üßà ${m.gras}g</span>
            </div>
        </div>`;
            for (const [sec, mcfg] of Object.entries(MEAL_CONFIG)) {
                const items = data.secciones[sec] || [];
                html += `
            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-icon">${mcfg.icon}</span>
                    <span class="meal-name ${sec}">${mcfg.label}</span>
                    <span class="meal-count">${items.length}</span>
                </div>
                <div class="meal-items">`;
                for (const p of items) {
                    html += `<div class="product-row">
                    <span class="p-emoji">${p.emoji || 'üì¶'}</span>
                    <span class="p-name">${p.nombre}</span>
                    <span class="p-price">${p.precio.toFixed(2)}‚Ç¨</span>
                </div>`;
                }
                if (!items.length) html += `<div style="color:#ccc;font-size:0.8rem;padding:6px 0;">‚Äî</div>`;
                html += `</div></div>`;
            }
            html += `<div class="version-footer">${data.total_productos} productos</div>`;
            card.innerHTML = html;
            return card;
        }

        // ========== START ==========
        init();
    </script>
</body>

</html>